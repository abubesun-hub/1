<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إصلاح تسجيل الدخول - نظام المحاسبة</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            direction: rtl;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 500px;
            width: 100%;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
            width: 100%;
        }
        .btn:hover {
            background: #5a6fd8;
        }
        .success {
            background: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }
        .error {
            background: #f44336;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }
        .info {
            background: #2196F3;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .login-test {
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            direction: ltr;
            text-align: left;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 إصلاح نظام تسجيل الدخول</h1>
        
        <div class="info">
            <strong>هذه الصفحة لإصلاح مشاكل تسجيل الدخول</strong><br>
            استخدم الأزرار أدناه لحل المشكلة
        </div>

        <div id="successMsg" class="success"></div>
        <div id="errorMsg" class="error"></div>

        <button class="btn" onclick="clearAllData().catch(e => showMessage('حدث خطأ: ' + e.message, 'error'))">🗑️ مسح جميع البيانات وإعادة التعيين</button>
        
        <button class="btn" onclick="resetUsers()">👤 إعادة تعيين المستخدمين الافتراضيين</button>
        
        <button class="btn" onclick="checkCurrentData()">🔍 فحص البيانات الحالية</button>

        <div class="login-test">
            <h3>اختبار تسجيل الدخول:</h3>
            <form id="loginForm" onsubmit="event.preventDefault(); testLogin();">
                <label for="testUsername">اسم المستخدم:</label>
                <input type="text" id="testUsername" value="admin" placeholder="admin" required aria-required="true">
                
                <label for="testPassword">كلمة المرور:</label>
                <input type="password" id="testPassword" value="admin123" placeholder="admin123" required aria-required="true">
                
                <button id="loginBtn" class="btn" type="submit">
                    <span id="loginText">🔐 اختبار تسجيل الدخول</span>
                    <span id="loginSpinner" style="display:none;">⌛ جاري المعالجة...</span>
                </button>
            </form>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn" onclick="goToMainSystem()" style="background: #4CAF50;">
                ✅ الذهاب إلى النظام الرئيسي
            </button>
            <button class="btn" onclick="logout()" style="background: #f44336;">
                🚪 تسجيل الخروج
            </button>
        </div>
    </div>

    <script>
        function showMessage(message, type) {
            const successMsg = document.getElementById('successMsg');
            const errorMsg = document.getElementById('errorMsg');
            
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';
            
            if (type === 'success') {
                successMsg.textContent = message;
                successMsg.style.display = 'block';
            } else {
                errorMsg.textContent = message;
                errorMsg.style.display = 'block';
            }
        }

        async function clearAllData() {
            try {
                localStorage.clear();
                sessionStorage.clear();
                showMessage('تم مسح جميع البيانات وجلسات المستخدمين بنجاح!', 'success');
                await resetUsers();
            } catch (error) {
                showMessage('خطأ في مسح البيانات: ' + error.message, 'error');
            }
        }

        async function resetUsers() {
            try {
                // إنشاء المستخدمين الافتراضيين
                const defaultUsers = [
                    {
                        id: 'admin-001',
                        username: 'admin',
                        password: await hashPassword('admin123', 'salt-admin'),
                        salt: 'salt-admin',
                        name: 'المدير العام',
                        role: 'admin',
                        permissions: ['all'],
                        isActive: true,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'manager-001',
                        username: 'manager',
                        password: await hashPassword('manager123', 'salt-manager'),
                        salt: 'salt-manager',
                        name: 'مدير القسم',
                        role: 'manager',
                        permissions: ['capital', 'expenses', 'reports', 'users'],
                        isActive: true,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'accountant-001',
                        username: 'accountant',
                        password: await hashPassword('acc123', 'salt-accountant'),
                        salt: 'salt-accountant',
                        name: 'المحاسب',
                        role: 'accountant',
                        permissions: ['capital', 'expenses', 'reports'],
                        isActive: true,
                        createdAt: new Date().toISOString()
                    }
                ];

                // حفظ المستخدمين
                const encryptedUsers = btoa(unescape(encodeURIComponent(JSON.stringify(defaultUsers))));
                localStorage.setItem('accounting_users', encryptedUsers);
                
                // إنشاء بيانات فارغة أخرى
                localStorage.setItem('accounting_capital', btoa(unescape(encodeURIComponent(JSON.stringify([])))));
                localStorage.setItem('accounting_expenses', btoa(unescape(encodeURIComponent(JSON.stringify([])))));
                localStorage.setItem('accounting_shareholders', btoa(unescape(encodeURIComponent(JSON.stringify([])))));
                
                showMessage('تم إعادة تعيين المستخدمين بنجاح!\nيمكنك الآن تسجيل الدخول بـ:\nadmin / admin123', 'success');
            } catch (error) {
                showMessage('خطأ في إعادة تعيين المستخدمين: ' + error.message, 'error');
            }
        }

        async function hashPassword(password, salt) {
            try {
                // Validate inputs
                if (!password || password.length === 0) {
                    throw new Error('كلمة المرور فارغة');
                }
                if (!salt || salt.length === 0) {
                    throw new Error('الملح فارغ');
                }
                
                const encoder = new TextEncoder();
                const data = encoder.encode(password + salt);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                
                console.log('تجزئة كلمة المرور:', {
                    password,
                    salt,
                    hash: hashHex
                });
                
                return hashHex;
            } catch (error) {
                console.error('خطأ في تجزئة كلمة المرور:', error);
                throw error;
            }
        }

        async function checkCurrentData() {
            try {
                const users = localStorage.getItem('accounting_users');
                if (!users) {
                    showMessage('لا توجد بيانات مستخدمين. اضغط "إعادة تعيين المستخدمين"', 'error');
                    return;
                }

                const decryptedUsers = JSON.parse(decodeURIComponent(escape(atob(users))));
                
                // تحويل كلمات المرور القديمة إلى النظام الجديد
                let convertedCount = 0;
                for (const user of decryptedUsers) {
                    if (!user.salt && user.password.length < 64) {
                        const salt = 'converted-salt-' + Math.random().toString(36).substring(2);
                        user.salt = salt;
                        user.password = await hashPassword(user.password, salt);
                        convertedCount++;
                    }
                }
                
                if (convertedCount > 0) {
                    const encryptedUsers = btoa(unescape(encodeURIComponent(JSON.stringify(decryptedUsers))));
                    localStorage.setItem('accounting_users', encryptedUsers);
                    showMessage(`تم تحويل ${convertedCount} مستخدم إلى نظام التجزئة الجديد`, 'success');
                } else {
                    showMessage(`تم العثور على ${decryptedUsers.length} مستخدم في النظام (جميعهم محدثون)`, 'success');
                }
                
                console.log('المستخدمون الحاليون:', decryptedUsers);
            } catch (error) {
                showMessage('خطأ في قراءة البيانات: ' + error.message, 'error');
            }
        }

        async function testLogin() {
            const username = document.getElementById('testUsername').value.trim();
            const password = document.getElementById('testPassword').value.trim();
            
            // التحقق من المدخلات الفارغة
            if (!username || !password) {
                showMessage('يرجى إدخال اسم المستخدم وكلمة المرور', 'error');
                return;
            }
            
            // عرض مؤشر التحميل
            const loginBtn = document.getElementById('loginBtn');
            const loginText = document.getElementById('loginText');
            const loginSpinner = document.getElementById('loginSpinner');
            loginText.style.display = 'none';
            loginSpinner.style.display = 'inline';
            loginBtn.disabled = true;

            try {
                console.log('بدء محاولة تسجيل الدخول:', { username });
                const users = localStorage.getItem('accounting_users');
                
                if (!users) {
                    console.error('لا توجد بيانات مستخدمين في localStorage');
                    showMessage('لا توجد بيانات مستخدمين. اضغط "إعادة تعيين المستخدمين" أولاً', 'error');
                    return;
                }

                const decryptedUsers = JSON.parse(decodeURIComponent(escape(atob(users))));
                console.log('المستخدمون المفكوكون:', decryptedUsers);
                
                const user = decryptedUsers.find(u => u.username === username);
                
                if (!user) {
                    console.error('المستخدم غير موجود:', username);
                    showMessage('اسم المستخدم غير موجود. الرجاء التأكد من المعلومات المدخلة', 'error');
                    return;
                }
                
                console.log('تم العثور على المستخدم:', user);

                const hashedPassword = await hashPassword(password, user.salt);
                console.log('كلمة المرور المدخلة:', password);
                console.log('كلمة المرور المشفرة المدخلة:', hashedPassword);
                console.log('كلمة المرور المخزنة:', user.password);
                
                if (user.password === hashedPassword) {
                    console.log('كلمة المرور صحيحة');
                    showMessage('نجح تسجيل الدخول! ✅ سيتم تحويلك إلى النظام الرئيسي خلال ثوانٍ', 'success');
                    
                    // حفظ جلسة المستخدم
                    const sessionUser = { ...user };
                    delete sessionUser.password;
                    delete sessionUser.salt;
                    sessionStorage.setItem('currentUser', JSON.stringify(sessionUser));
                    sessionStorage.setItem('sessionStart', Date.now().toString());
                    
                    // الانتقال إلى النظام بعد تأخير قصير
                    setTimeout(() => {
                        goToMainSystem();
                    }, 2000);
                } else {
                    console.error('كلمة المرور غير متطابقة');
                    showMessage('كلمة المرور غير صحيحة. الرجاء التأكد من المعلومات المدخلة', 'error');
                }
            } catch (error) {
                console.error('حدث خطأ أثناء تسجيل الدخول:', error);
                showMessage('حدث خطأ أثناء تسجيل الدخول: ' + error.message, 'error');
            } finally {
                // إعادة عرض الزر وإخفاء المؤشر
                loginText.style.display = 'inline';
                loginSpinner.style.display = 'none';
                loginBtn.disabled = false;
            }
        }

        function goToMainSystem() {
            window.location.href = 'index.html';
        }

        function logout() {
            sessionStorage.clear();
            showMessage('تم تسجيل الخروج بنجاح', 'success');
        }

        // تشغيل تلقائي عند تحميل الصفحة
        window.onload = function() {
            checkCurrentData();
        };
    </script>
</body>
</html>
