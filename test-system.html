<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار النظام - نموذج المصروفات المطور</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <style>
        .test-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        .status-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .status-success {
            border-color: #198754;
            background-color: #d1e7dd;
        }
        .status-error {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        .test-button {
            margin: 5px;
            min-width: 200px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="test-header">
            <h1><i class="bi bi-gear me-2"></i>اختبار النظام</h1>
            <p>اختبار نموذج المصروفات المطور والمميزات الجديدة</p>
        </div>

        <!-- Status Cards -->
        <div class="row">
            <div class="col-md-4">
                <div id="storageStatus" class="status-card">
                    <h6><i class="bi bi-database me-2"></i>حالة التخزين</h6>
                    <p id="storageText">جاري الفحص...</p>
                </div>
            </div>
            <div class="col-md-4">
                <div id="expensesStatus" class="status-card">
                    <h6><i class="bi bi-receipt me-2"></i>مدير المصروفات</h6>
                    <p id="expensesText">جاري الفحص...</p>
                </div>
            </div>
            <div class="col-md-4">
                <div id="systemStatus" class="status-card">
                    <h6><i class="bi bi-cpu me-2"></i>حالة النظام</h6>
                    <p id="systemText">جاري الفحص...</p>
                </div>
            </div>
        </div>

        <!-- Test Buttons -->
        <div class="text-center mb-4">
            <h4>اختبارات سريعة</h4>
            <div class="d-flex flex-wrap justify-content-center">
                <button class="btn btn-primary test-button" onclick="testExpensesManager()">
                    <i class="bi bi-receipt me-2"></i>اختبار مدير المصروفات
                </button>
                <button class="btn btn-success test-button" onclick="loadExpenseForm()">
                    <i class="bi bi-plus-circle me-2"></i>تحميل نموذج المصروف
                </button>
                <button class="btn btn-warning test-button" onclick="testPrintFunction()">
                    <i class="bi bi-printer me-2"></i>اختبار الطباعة
                </button>
                <button class="btn btn-info test-button" onclick="openMainSystem()">
                    <i class="bi bi-house me-2"></i>النظام الرئيسي
                </button>
            </div>
        </div>

        <!-- Content Area -->
        <div id="contentArea">
            <div class="text-center">
                <p class="text-muted">اختر أحد الاختبارات أعلاه لبدء الاختبار</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/storage.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/expenses.js"></script>
    
    <script>
        let expensesManager;
        
        // Check system status on load
        document.addEventListener('DOMContentLoaded', function() {
            checkSystemStatus();
        });
        
        function checkSystemStatus() {
            // Check StorageManager
            if (typeof StorageManager !== 'undefined') {
                document.getElementById('storageStatus').className = 'status-card status-success';
                document.getElementById('storageText').textContent = 'متوفر ويعمل';
            } else {
                document.getElementById('storageStatus').className = 'status-card status-error';
                document.getElementById('storageText').textContent = 'غير متوفر';
            }
            
            // Check ExpensesManager
            if (typeof ExpensesManager !== 'undefined') {
                document.getElementById('expensesStatus').className = 'status-card status-success';
                document.getElementById('expensesText').textContent = 'متوفر ويعمل';
            } else {
                document.getElementById('expensesStatus').className = 'status-card status-error';
                document.getElementById('expensesText').textContent = 'غير متوفر';
            }
            
            // Overall system status
            if (typeof StorageManager !== 'undefined' && typeof ExpensesManager !== 'undefined') {
                document.getElementById('systemStatus').className = 'status-card status-success';
                document.getElementById('systemText').textContent = 'جميع المكونات تعمل';
            } else {
                document.getElementById('systemStatus').className = 'status-card status-error';
                document.getElementById('systemText').textContent = 'بعض المكونات لا تعمل';
            }
        }
        
        function testExpensesManager() {
            try {
                if (!expensesManager) {
                    expensesManager = new ExpensesManager();
                }
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="alert alert-success">
                        <h5><i class="bi bi-check-circle me-2"></i>نجح اختبار مدير المصروفات</h5>
                        <p>تم إنشاء مدير المصروفات بنجاح ويعمل بشكل صحيح.</p>
                        <button class="btn btn-primary" onclick="loadExpenseForm()">تحميل نموذج المصروف</button>
                    </div>
                `;
            } catch (error) {
                document.getElementById('contentArea').innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="bi bi-x-circle me-2"></i>فشل اختبار مدير المصروفات</h5>
                        <p>خطأ: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function loadExpenseForm() {
            try {
                if (!expensesManager) {
                    expensesManager = new ExpensesManager();
                }
                
                // Create a container for the form
                document.getElementById('contentArea').innerHTML = '<div id="expensesContent"></div>';
                
                // Load the add expense view
                expensesManager.loadAddExpenseView();
                
                // Add success message
                setTimeout(() => {
                    const successMsg = document.createElement('div');
                    successMsg.className = 'alert alert-success mt-3';
                    successMsg.innerHTML = `
                        <h6><i class="bi bi-check-circle me-2"></i>تم تحميل النموذج بنجاح!</h6>
                        <p>النموذج المطور جاهز للاستخدام مع جميع المميزات الجديدة.</p>
                    `;
                    document.getElementById('contentArea').insertBefore(successMsg, document.getElementById('expensesContent'));
                }, 500);
                
            } catch (error) {
                document.getElementById('contentArea').innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="bi bi-x-circle me-2"></i>فشل تحميل النموذج</h5>
                        <p>خطأ: ${error.message}</p>
                        <button class="btn btn-warning" onclick="location.reload()">إعادة تحميل الصفحة</button>
                    </div>
                `;
            }
        }
        
        function testPrintFunction() {
            if (!expensesManager) {
                alert('يرجى تحميل نموذج المصروف أولاً');
                return;
            }
            
            // Fill test data first
            if (typeof expensesManager.fillTestData === 'function') {
                expensesManager.fillTestData();
                
                setTimeout(() => {
                    if (typeof expensesManager.printInvoice === 'function') {
                        expensesManager.printInvoice();
                    } else {
                        alert('دالة الطباعة غير متوفرة');
                    }
                }, 1000);
            } else {
                alert('دالة البيانات التجريبية غير متوفرة');
            }
        }
        
        function openMainSystem() {
            window.open('index.html', '_blank');
        }
    </script>
</body>
</html>
